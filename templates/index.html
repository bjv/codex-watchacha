{% extends "base.html" %}

{% block title %}Listings ‚Äì Watchacha Dashboard{% endblock %}

{% block content %}
<div class="space-y-10">
    <section class="rounded-2xl border border-white/10 bg-panel p-6 shadow-xl shadow-black/20">
        <div class="flex flex-col gap-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <h2 class="text-lg font-semibold text-white">Filters</h2>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                    <span>{{ items|length }} Listings</span>
                </div>
            </div>
            <form class="grid gap-4 md:grid-cols-2 xl:grid-cols-4" method="get">
                <label class="flex flex-col gap-2 text-sm text-slate-300">
                    Suchbegriff
                    <input type="text" name="q" value="{{ query }}" class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-3 py-2 text-white placeholder:text-slate-500 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40" placeholder="z. B. BlueBrixx Shuttle">
                </label>
                <label class="flex flex-col gap-2 text-sm text-slate-300">
                    Anbieter
                    <select name="provider" class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-3 py-2 text-white focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40">
                        <option value="">Alle</option>
                        {% for prov in providers %}
                            <option value="{{ prov.key }}" {% if provider_filter == prov.key %}selected{% endif %}>{{ prov.label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="flex flex-col gap-2 text-sm text-slate-300">
                    Set
                    <select name="set_nr" class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-3 py-2 text-white focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40">
                        <option value="">Alle</option>
                        {% for option in set_options %}
                            <option value="{{ option.nr }}" {% if set_filter == option.nr %}selected{% endif %}>
                                {{ option.nr }}{% if option.name %} ‚Äì {{ option.name }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </label>
                <label class="flex flex-col gap-2 text-sm text-slate-300">
                    Limit
                    <input type="number" name="limit" value="{{ limit }}" min="1" max="200" class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-3 py-2 text-white focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40">
                </label>
                <label class="flex items-center gap-3 text-sm text-slate-300">
                    <input type="checkbox" name="show_hidden" value="1" {% if show_hidden %}checked{% endif %} class="h-4 w-4 rounded border-white/20 bg-slate-900 text-brand focus:ring-brand/60">
                    Versteckte Listings anzeigen
                </label>
                <div class="flex items-center gap-2">
                    <button type="submit" title="Filter anwenden" class="rounded-xl bg-brand px-4 py-2 text-sm font-semibold text-black shadow-lg shadow-brand/40 transition hover:bg-sky-400">üîç Anwenden</button>
                    <a href="/" class="rounded-xl border border-white/20 px-4 py-2 text-sm font-semibold text-slate-300 transition hover:bg-white/10">‚ùå Reset</a>
                </div>
            </form>
            <div class="flex flex-wrap items-center gap-2">
                <span class="text-xs uppercase tracking-wide text-slate-400">Sortierung:</span>
                {% for key, state in sort_state.items() %}
                    <a href="{{ state.url }}"
                       class="rounded-full border px-3 py-1 text-xs font-medium transition {{ 'bg-brand text-black border-transparent shadow shadow-brand/40' if state.current else 'border-white/10 text-slate-300 hover:bg-white/10' }}">
                        {{ state.label }}
                        {% if state.current == 'desc' %}‚ñº{% elif state.current == 'asc' %}‚ñ≤{% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>
    </section>

    {% if items %}
        <section class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
            {% for item in items %}
                <article class="group relative overflow-hidden rounded-2xl border border-white/10 bg-panel p-5 shadow-xl shadow-black/30 transition hover:border-brand/60 {% if item.hidden %}opacity-60{% endif %}">
                    <div class="absolute inset-x-10 top-0 h-px bg-gradient-to-r from-transparent via-brand/70 to-transparent"></div>
                    <div class="flex items-start justify-between gap-4">
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-400">
                                <span class="rounded-full bg-white/10 px-2 py-0.5 text-white">{{ item.provider }}</span>
                                <span class="text-slate-500">{{ item.provider_item_id }}</span>
                                {% if item.hidden %}<span class="rounded-full bg-orange-500/20 px-2 py-0.5 text-orange-300">Versteckt</span>{% endif %}
                                {% set avail = item.availability %}
                                {% if item.completed %}
                                    <span class="rounded-full bg-rose-500/20 px-2 py-0.5 text-rose-200">Abgeschlossen</span>
                                {% elif avail != 'active' %}
                                    <span class="rounded-full bg-amber-500/20 px-2 py-0.5 text-amber-200">{{ item.availability_label }}</span>
                                {% else %}
                                    <span class="rounded-full bg-emerald-500/20 px-2 py-0.5 text-emerald-200">{{ item.availability_label }}</span>
                                {% endif %}
                                {% if item.last_revisit_ts %}
                                    <span class="rounded-full bg-white/10 px-2 py-0.5 text-xs text-slate-300">Revisit {{ item.last_revisit_ts.strftime('%Y-%m-%d %H:%M') }}</span>
                                {% endif %}
                            </div>
                            <h3 class="text-lg font-semibold text-white">
                                <a href="/items/{{ item.id }}" class="hover:text-brand transition">{{ item.title }}</a>
                            </h3>
                            <div class="flex flex-wrap items-center gap-3 text-sm text-slate-300">
                                <a href="{{ item.href }}" target="_blank" rel="noopener" class="inline-flex items-center gap-1 rounded-full border border-white/5 px-3 py-1 text-xs text-slate-200 hover:border-brand/50 hover:text-brand">
                                    üîó Direktlink
                                </a>
                                {% if item.direct_buy %}<span class="rounded-full bg-emerald-500/20 px-2 py-0.5 text-emerald-300 text-xs">Direkt</span>{% endif %}
                                {% if item.vb_flag %}<span class="rounded-full bg-amber-500/20 px-2 py-0.5 text-amber-300 text-xs">VB</span>{% endif %}
                            </div>
                        </div>
                        <div class="text-right text-sm text-slate-300">
                            <div class="font-semibold text-emerald-300">{{ item.best_price }}</div>
                            <div class="text-xs text-slate-500">
                                Gebot {{ item.current_bid or '-' }}<br>
                                Sofort {{ item.current_buyout or '-' }}
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 space-y-3">
                        {% if item.set %}
                            <div class="rounded-xl border border-white/10 bg-slate-900/70 p-4">
                                <div class="flex flex-wrap items-center gap-2 text-sm text-slate-200">
                                    <a href="/sets/{{ item.set.nr }}" class="font-semibold text-brand">Set {{ item.set.nr }}</a>
                                    {% if item.set.name %}<span class="text-slate-400">{{ item.set.name }}</span>{% endif %}
                                </div>
                                <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-400">
                                    <span class="rounded-full bg-brand/10 px-2 py-0.5 text-brand">Score {{ '%.2f' % item.set.score }}</span>
                                    {% if item.set.manual_override %}<span class="rounded-full bg-orange-500/20 px-2 py-0.5 text-orange-300">Manuell</span>{% endif %}
                                    {% if item.set.original_score is not none %}<span class="rounded-full bg-white/10 px-2 py-0.5 text-slate-300">Orig {{ '%.2f' % item.set.original_score }}</span>{% endif %}
                                    {% if item.set.matched_number %}<span class="rounded-full bg-white/10 px-2 py-0.5 text-slate-300">Nr</span>{% endif %}
                                    {% if item.set.parts_difference is not none %}<span class="rounded-full bg-white/10 px-2 py-0.5 text-slate-300">Œî Teile {{ item.set.parts_difference }}</span>{% endif %}
                                    {% if item.set.name_score is not none %}<span class="rounded-full bg-white/10 px-2 py-0.5 text-slate-300">Name {{ '%.2f' % item.set.name_score }}</span>{% endif %}
                                </div>
                            </div>
                        {% else %}
                            <div class="rounded-xl border border-white/10 bg-slate-900/60 p-4 text-xs text-slate-400">
                                Kein Set erkannt
                            </div>
                        {% endif %}

                        <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
                            <span>Seit {{ item.first_seen_ts.strftime('%Y-%m-%d %H:%M') if item.first_seen_ts else '-' }}</span>
                            <span>Aktualisiert {{ item.last_seen_ts.strftime('%Y-%m-%d %H:%M') if item.last_seen_ts else '-' }}</span>
                            <span>Revisit {{ item.last_revisit_ts.strftime('%Y-%m-%d %H:%M') if item.last_revisit_ts else '-' }}</span>
                        </div>
                    </div>
                </article>
            {% endfor %}
        </section>
    {% else %}
        <div class="rounded-2xl border border-dashed border-white/20 bg-slate-900/40 p-10 text-center text-slate-400">
            Keine Listings gefunden.
        </div>
    {% endif %}
</div>
{% endblock %}
