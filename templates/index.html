{% extends "base.html" %}

{% block title %}Listings ‚Äì Watchacha Dashboard{% endblock %}

{% block content %}
    <h2>Aktuelle Listings</h2>
    <form class="filters" method="get">
        <label>
            Suchbegriff
            <input type="text" name="q" value="{{ query }}" placeholder="z. B. BlueBrixx">
        </label>
        <label>
            Anbieter
            <select name="provider">
                <option value="">Alle</option>
                {% for prov in providers %}
                    <option value="{{ prov.key }}" {% if provider_filter == prov.key %}selected{% endif %}>{{ prov.label }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Cluster-Key
            <select name="cluster">
                <option value="">Alle</option>
                {% for ck in clusters %}
                    <option value="{{ ck }}" {% if cluster_filter == ck %}selected{% endif %}>{{ ck }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Limit
            <input type="number" name="limit" value="{{ limit }}" min="1" max="200">
        </label>
        <div style="display:flex; align-items:flex-end; gap:8px;">
            <a href="/" title="Filter zur√ºcksetzen" style="display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:999px; background:rgba(255,255,255,0.08); text-decoration:none; color:var(--accent); font-size:1.2rem; line-height:1;">‚ùå</a>
            <button type="submit" title="Filter anwenden">üîç</button>
        </div>
    </form>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th class="col-provider">Anbieter</th>
                <th class="col-title">
                    <a class="sortable {% if sort_state['title']['current'] %}active{% endif %}" href="{{ sort_state['title']['url'] }}">
                        Listing
                        {% if sort_state['title']['current'] == 'desc' %}‚ñº{% elif sort_state['title']['current'] == 'asc' %}‚ñ≤{% endif %}
                    </a>
                </th>
                <th class="col-price">
                    <a class="sortable {% if sort_state['price']['current'] %}active{% endif %}" href="{{ sort_state['price']['url'] }}">
                        Preis
                        {% if sort_state['price']['current'] == 'desc' %}‚ñº{% elif sort_state['price']['current'] == 'asc' %}‚ñ≤{% endif %}
                    </a>
                </th>
                <th class="col-flags">Merker</th>
                <th class="col-cluster">Cluster</th>
                <th class="col-seen">
                    <a class="sortable {% if sort_state['last_seen']['current'] %}active{% endif %}" href="{{ sort_state['last_seen']['url'] }}">
                        Gesehen
                        {% if sort_state['last_seen']['current'] == 'desc' %}‚ñº{% elif sort_state['last_seen']['current'] == 'asc' %}‚ñ≤{% endif %}
                    </a>
                </th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr>
                <td class="col-provider">
                    <div class="badge">{{ item.provider }}</div>
                    <small class="muted">{{ item.provider_item_id }}</small>
                </td>
                <td class="col-title">
                    <a href="/items/{{ item.id }}">{{ item.title }}</a>
                    <small><a href="{{ item.href }}" target="_blank" rel="noopener" class="muted">üîó Direktlink</a></small>
                </td>
                <td class="col-price">
                    <div>
                        {% if item.current_buyout != '-' %}
                            <strong>{{ item.current_buyout }}</strong><small>Sofort</small>
                        {% endif %}
                        {% if item.current_bid != '-' %}
                            <div>{{ item.current_bid }}<small>Gebot</small></div>
                        {% endif %}
                        {% if item.current_buyout == '-' and item.current_bid == '-' %}
                            <span class="muted">-</span>
                        {% endif %}
                    </div>
                </td>
                <td class="col-flags">
                    {% if item.direct_buy %}<span class="badge">Direkt</span>{% endif %}
                    {% if item.vb_flag %}<span class="badge">VB</span>{% endif %}
                </td>
                <td class="col-cluster">
                    {% if item.cluster_keys %}
                        {% for ck in item.cluster_keys %}
                            <span class="badge">{{ ck }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="muted">‚Äì</span>
                    {% endif %}
                </td>
                <td class="col-seen">
                    <div>
                        <small>seit {{ item.first_seen_ts.strftime('%Y-%m-%d %H:%M') if item.first_seen_ts else '-' }}</small>
                        <div>{{ item.last_seen_ts.strftime('%Y-%m-%d %H:%M') if item.last_seen_ts else '-' }}</div>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="muted">Keine Treffer ‚Äì such weiter! üîç</p>
    {% endif %}
{% endblock %}
