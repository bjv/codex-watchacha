{% extends "base.html" %}

{% block title %}Set {{ set.set_nr }} ‚Äì Watchacha Dashboard{% endblock %}

{% block content %}
<div class="space-y-8">
    <a href="/sets" class="inline-flex items-center gap-2 text-sm text-slate-300 transition hover:text-brand">‚Üê Zur√ºck zur Set-√úbersicht</a>

    <header class="rounded-2xl border border-white/10 bg-panel p-6 shadow-xl shadow-black/30">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h2 class="text-2xl font-semibold text-white">Set {{ set.set_nr }}</h2>
                {% if set.name %}<p class="text-sm text-slate-400">{{ set.name }}</p>{% endif %}
            </div>
            <div class="flex flex-wrap gap-2 text-xs text-slate-300">
                {% if set.release_date %}<span class="rounded-full bg-white/10 px-3 py-1">Release {{ set.release_date }}</span>{% endif %}
                {% if set.parts %}<span class="rounded-full bg-white/10 px-3 py-1">{{ set.parts }} Teile</span>{% endif %}
                {% if set.category %}<span class="rounded-full bg-white/10 px-3 py-1">{{ set.category }}</span>{% endif %}
                {% if set.era %}<span class="rounded-full bg-white/10 px-3 py-1">{{ set.era }}</span>{% endif %}
                {% if set.series %}<span class="rounded-full bg-white/10 px-3 py-1">{{ set.series }}</span>{% endif %}
            </div>
        </div>
        {% if set.features %}
            <p class="mt-3 text-sm text-slate-400">{{ set.features }}</p>
        {% endif %}
    </header>

    <section class="rounded-2xl border border-white/10 bg-panel p-6 shadow-xl shadow-black/30">
        <form class="flex flex-wrap items-end gap-4" method="get">
            <label class="flex flex-col gap-2 text-sm text-slate-300">
                Anbieter
                <select name="provider" class="rounded-xl border border-white/10 bg-slate-900/70 px-3 py-2 text-white focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40">
                    <option value="">Alle</option>
                    {% for prov in providers %}
                        <option value="{{ prov.key }}" {% if provider_filter == prov.key %}selected{% endif %}>{{ prov.label }}</option>
                    {% endfor %}
                </select>
            </label>
            <div class="flex items-center gap-3">
                <button type="submit" class="rounded-xl bg-brand px-4 py-2 text-sm font-semibold text-black shadow-lg shadow-brand/40 transition hover:bg-sky-400">üîç Anwenden</button>
                <a href="/sets/{{ set.set_nr }}" class="rounded-xl border border-white/10 px-4 py-2 text-sm text-slate-300 transition hover:bg-white/10">‚ùå Reset</a>
            </div>
        </form>
    </section>

    <section class="rounded-2xl border border-white/10 bg-panel p-6 shadow-xl shadow-black/30 space-y-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Aktuelle Angebote</h3>
            <span class="text-xs text-slate-400">{{ active_total }} aktive Listings</span>
        </div>
        {% if active_groups %}
            <div class="space-y-8">
                {% for group in active_groups %}
                    <div class="space-y-3">
                        <div class="flex flex-wrap items-center justify-between gap-2">
                            <h4 class="text-base font-semibold text-white">{{ group.label }}</h4>
                            {% if group.stats %}
                                <div class="text-xs text-slate-400">
                                    {{ group.stats.count }} Angebote ‚Ä¢ √ò {{ group.stats.avg_price }}{% if group.stats.vb_count %} ‚Ä¢ {{ group.stats.vb_count }}√ó VB{% endif %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-white/10">
                            <table class="min-w-full divide-y divide-white/10 text-sm">
                                <thead class="bg-slate-900/60 text-xs uppercase tracking-wide text-slate-400">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Listing</th>
                                        <th class="px-4 py-3 text-left">Typ</th>
                                        <th class="px-4 py-3 text-left">Preis</th>
                                        <th class="px-4 py-3 text-left">Versand</th>
                                        <th class="px-4 py-3 text-left">Hinweis</th>
                                        <th class="px-4 py-3 text-left">Links</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5 text-slate-200">
                                    {% for listing in group.listings %}
                                        <tr class="hover:bg-white/5 transition">
                                            <td class="px-4 py-3 align-top">
                                                <div class="font-semibold text-white">
                                                    <a href="/items/{{ listing.id }}" class="hover:text-brand transition">{{ listing.title }}</a>
                                                </div>
                                                <div class="mt-1 text-xs text-slate-500 flex flex-wrap gap-2">
                                                    <span>{{ listing.provider_item_id }}</span>
                                                    <span>Aktualisiert {{ listing.last_seen_ts.strftime('%Y-%m-%d %H:%M') if listing.last_seen_ts else '-' }}</span>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 align-top text-slate-300">{{ listing.listing_type_label }}</td>
                                            <td class="px-4 py-3 align-top font-semibold text-emerald-300">{{ listing.display_price }}</td>
                                            <td class="px-4 py-3 align-top text-slate-300">{{ listing.shipping }}</td>
                                            <td class="px-4 py-3 align-top text-xs text-slate-400">
                                                {% if listing.has_auction and listing.current_bid != '-' %}
                                                    Gebot aktuell {{ listing.current_bid }}
                                                {% elif listing.is_vb %}
                                                    Verhandlungsbasis
                                                {% elif listing.direct_buy %}
                                                    Sofortkauf verf√ºgbar
                                                {% else %}
                                                    {{ listing.availability_label }}
                                                {% endif %}
                                            </td>
                                            <td class="px-4 py-3 align-top text-sm">
                                                <div class="flex gap-2">
                                                    <a href="{{ listing.href }}" target="_blank" rel="noopener" class="rounded-lg border border-white/20 px-3 py-1 text-xs text-slate-200 hover:border-brand/50 hover:text-brand">üîó Angebot</a>
                                                    <a href="/items/{{ listing.id }}" class="rounded-lg border border-white/20 px-3 py-1 text-xs text-slate-200 hover:border-brand/50 hover:text-brand">üóÇ Details</a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="rounded-2xl border border-dashed border-white/20 bg-slate-900/40 p-10 text-center text-slate-400">
                Keine aktiven Angebote gefunden.
            </div>
        {% endif %}
    </section>

    <section class="rounded-2xl border border-white/10 bg-panel p-6 shadow-xl shadow-black/30 space-y-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Markt (verkaufte Artikel)</h3>
            <span class="text-xs text-slate-400">{{ sales_total }} abgeschlossene Listings</span>
        </div>
        {% if market_stats %}
            <div class="grid gap-4 md:grid-cols-2">
                {% for stat in market_stats %}
                    <article class="rounded-2xl border border-white/10 bg-slate-900/60 p-5 shadow shadow-black/40">
                        <div class="flex items-center justify-between text-sm text-slate-200">
                            <h4 class="font-semibold text-white">{{ stat.label }}</h4>
                            <span>{{ stat.count }} Abschl√ºsse</span>
                        </div>
                        <div class="mt-3 text-sm text-slate-200">√ò {{ stat.avg_price }} ‚Ä¢ Min {{ stat.min_price }} ‚Ä¢ Max {{ stat.max_price }}</div>
                        <div class="mt-2 text-xs text-slate-400">{{ stat.note }}</div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="rounded-2xl border border-dashed border-white/20 bg-slate-900/40 p-10 text-center text-slate-400">
                Keine abgeschlossenen Verk√§ufe erfasst.
            </div>
        {% endif %}
    </section>

    <section class="rounded-2xl border border-white/10 bg-panel p-6 shadow-xl shadow-black/30 space-y-4">
        <h3 class="text-lg font-semibold text-white">Vergleich aktive Angebote</h3>
        {% if comparison_stats %}
            <div class="grid gap-4 md:grid-cols-2">
                {% for stat in comparison_stats %}
                    <article class="rounded-2xl border border-white/10 bg-slate-900/60 p-5 shadow shadow-black/40">
                        <div class="flex items-center justify-between text-sm text-slate-200">
                            <h4 class="font-semibold text-white">{{ stat.label }}</h4>
                            <span>{{ stat.count }} Angebote</span>
                        </div>
                        <div class="mt-3 text-sm text-slate-200">√ò {{ stat.avg_price }}</div>
                        <div class="mt-2 text-xs text-slate-400">Min {{ stat.min_price }} ‚Ä¢ Median {{ stat.median_price }} ‚Ä¢ Max {{ stat.max_price }}</div>
                        {% if stat.sparkline %}
                            <div class="mt-3 font-mono text-lg tracking-tight text-brand">{{ stat.sparkline }}</div>
                        {% endif %}
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="rounded-2xl border border-dashed border-white/20 bg-slate-900/40 p-10 text-center text-slate-400">
                Keine aktiven Angebote zum Vergleich vorhanden.
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}
